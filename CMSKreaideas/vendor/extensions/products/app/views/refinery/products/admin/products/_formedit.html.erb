<%= javascript_include_tag :defaults %>
<%= javascript_include_tag :defaults, "nested_form" %>
<script type="text/javascript">

  var KI = KI || {};
  KI.File = {
    ui : {
      deletefilelink : null,
    },
    initialize : function(){
      this.ui.fileform=document.getElementById("actualfile");
      this.ui.delete_file_link = document.getElementById("delete_file_link");
      this.ui.product_delete_attach= document.getElementById("product_delete_attach");
      this.ui.change_file_link= document.getElementById("change_file_link");
      this.ui.addfile=document.getElementById("addfile");
      this.ui.add_file_link=document.getElementById("add_file_link");
      this.ui.product_attach=document.getElementById("product_attach");
      this.ui.cancelbrowse= document.getElementById("cancelbrowse");
      this.ui.cancelbrowseinfirst= document.getElementById("cancelbrowseifirst");
      this.ui.cancelbrowseinnew= document.getElementById("cancelbrowseinnew");
    }
    'delete' : function(){
      //funcion para borrarle un archivo de descarga a un producto
      this.ui.product_delete_attach.checked=true;
      this.ui.fileform.removeChild(this.ui.delete_file_link);
      this.ui.fileform.removeChild(this.ui.change_file_link); 

      var addfile2= document.createElement("a");
      addfile2.innerHTML = "Agregar Archivo";
      addfile2.id="addfile";
      addfile2.setAttribute("onclick","KI.File.new();");
      this.ui.fileform.appendChild(addfile2);

    },
    'new' : function(){
    //funcion para agregar un archivo a un producto que ya tenia
    this.ui.product_delete_attach.checked=false;
    var productattach= document.createElement("input");
    productattach.type="file";
    productattach.id="product_attach";
    productattach.name="product[attach]";
    this.ui.fileform.removeChild(this.ui.addfile);
    this.ui.fileform.appendChild(productattach);
    var cancelbrowseinnew= document.createElement("a");
    cancelbrowseinnew.innerHTML = "Cancelar";
    cancelbrowseinnew.id="cancelbrowseinnew";
    cancelbrowseinnew.setAttribute("onclick","KI.File.cancel_browse_in_new();");    
    this.ui.fileform.appendChild(cancelbrowseinnew);
    }
  add_first : function()
  {
    //agregar un archivo a un producto que no tenia
    this.ui.product_delete_attach.checked=false;
    var attachfile= document.createElement("input");
    attachfile.id="product_attach"
    attachfile.type="file";
    attachfile.name="product[attach]";
    var cancelbrowseinfirst= document.createElement("a");
    cancelbrowseinfirst.innerHTML = "Cancelar";
    cancelbrowseinfirst.id="cancelbrowseinfirst";
    cancelbrowseinfirst.setAttribute("onclick","KI.File.cancel_browse_in_first();");
    this.ui.fileform.removeChild(this.ui.add_file_link);
    this.ui.fileform.appendChild(attachfile);
    this.ui.fileform.appendChild(cancelbrowseinfirst);
  }

   cancel_browse_in_edit : function()
  {
    this.ui.fileform.removeChild(this.ui.product_attach);
    var deletefilelink= document.createElement("a");
    deletefilelink.innerHTML = "Eliminar";
    deletefilelink.id="delete_file_link";
    deletefilelink.setAttribute("onclick","KI.File.delete;");
    var changefilelink= document.createElement("a");
    changefilelink.innerHTML = "Cambiar";
    changefilelink.id="change_file_link";
    changefilelink.setAttribute("onclick","KI.File.change();");   
    this.ui.fileform.removeChild(this.ui.cancelbrowse);
    this.ui.fileform.appendChild(deletefilelink);
    this.ui.fileform.appendChild(changefilelink);
  }
 cancel_browse_in_first : function()
  {
    this.ui.product_delete_attach.checked=true;
    this.ui.fileform.removeChild(this.ui.cancelbrowseinfirst);
    this.ui.fileform.removeChild(this.ui.product_attach);
    var addfile2= document.createElement("a");
    addfile2.innerHTML = "Agregar Archivo";
    addfile2.id="add_file_link";
    addfile2.setAttribute("onclick","KI.File.add_first();");
    this.ui.fileform.appendChild(addfile2);
  }

  cancel_browse_in_new : function ()
  {
    this.ui.product_delete_attach.checked=true;
    this.ui.fileform.removeChild(this.ui.cancelbrowseinnew);
    this.ui.fileform.removeChild(this.ui.product_attach);
    var addfile2= document.createElement("a");
    addfile2.innerHTML = "Agregar Archivo";
    addfile2.id="addfile";
    addfile2.setAttribute("onclick","KI.File.new();");
    form.appendChild(addfile2);
  }

  change  : function()
  {
   var attachfile= document.createElement("input");
    attachfile.id="product_attach"
    attachfile.type="file";
    attachfile.name="product[attach]";
    this.ui.fileform.removeChild(this.ui.delete_file_link);
    this.ui.fileform.removeChild(this.ui.change_file_link);
    this.ui.fileform.appendChild(attachfile);
    var cancelbrowse= document.createElement("a");
    cancelbrowse.innerHTML = "Cancelar";
    cancelbrowse.id="cancelbrowse";
    cancelbrowse.setAttribute("onclick","KI.File.cancel_browse_in_edit();");
    this.ui.fileform.appendChild(cancelbrowse);
  }
  };



 



//script para traer las categorias y las subcategorias de la primera cateogoria
    $(document).ready(function(){
        //document.getElementById("product_delete_attach").style.visibility="hidden";
       //document.getElementById("product_attach").style.visibility="hidden";
        $("select#category_category_id").change(function(){
            var id_value_string = $(this).val();
            if (id_value_string == "") {
                // if the id is empty remove all the sub_selection options from being selectable and do not do any ajax
                $("select#product_subcategory_id").remove();
                var row = "<option value=\"" + "" + "\">" + "" + "</option>";
                $(row).appendTo("product_subcategory_id");
            }
            else {
                // Send the request and update sub category dropdownFADD_NEW_FILE
                $.ajax({
                    dataType: "json",
                    cache: false,
                    url: '/subcategories/search_by_category/'+id_value_string+'.json' ,
                    data:  id_value_string,
                    timeout: 2000,
                    error: function(XMLHttpRequest, errorTextStatus, error){
                        alert("Failed to submit : "+ errorTextStatus+" ;"+error);
                    },
                    success: function(data){                    
                        // Clear all options from sub category select
                        $("select#product_subcategory_id option").remove();
                        $.each(data, function(i, subcategory){
                             row = "<option value=\"" + subcategory.id + "\">" + subcategory.name + "</option>";  
                            $(row).appendTo("select#product_subcategory_id");                    
                        });            
                     }
                });
            };
                });

                $(document).ready(function(){
     
                var id_value_string= $("select#product_subcategory_id").val();
               // Send the request and update sub category dropdown
                $.ajax({
                    dataType: "json",
                    cache: false,
                    url: '/subcategories/get_category_by_subcategory/'+id_value_string+'.json' ,
                    data:  id_value_string,
                    timeout: 2000,
                    error: function(XMLHttpRequest, errorTextStatus, error){
                        alert("Failed to submit : "+ errorTextStatus+" ;"+error);
                    },
                    success: function(data){                    
                             $("#category_category_id").val(data["id"]);                 
                     }
                });



    });
</script>

  <div id="form">
  <%= nested_form_for [refinery, :products_admin, @product] do |f| -%>

    <% if @product.errors.any? %>  
      <div id="errorExplanation">  
        <h2>
          <%= pluralize(@product.errors.count, "error") %> prohibited this user from being saved:
        </h2>  
        <ul>  
          <% @product.errors.full_messages.each do |msg| %>  
            <li>
              <%= msg %>
            </li>  
          <% end %>  
        </ul>  
      </div> 
      <%= render '/refinery/admin/error_messages',  :object => @product,  :include_object_name => true %>
    <% end %>

    <h3>  Imagenes representativas</h3>
    <%= f.fields_for :productimages do |task| %>
      <% if task.object.image.url != "/images/original/missing.png" %>
        <%= image_tag task.object.image.url%>
      <% end %>
      <br>
      <%= task.file_field :image %>
      <%= task.link_to_remove "-" %>
      </br>
    <% end %>
    <p>
      <%= f.link_to_add "+", :productimages %>
    </p>  
    <div class='field'>
      <%= f.label :code -%>
      <%= f.text_field :code -%>
    </div>
    <div class='field'>
      <%= f.label :stock -%>
      <%= f.text_field :stock -%>
    </div>
    <div class='field'>
      <%= f.label :name -%>
      <%= f.text_field :name -%>
    </div>

    <div class='field'>
      <%= f.label :description -%>
      <%= f.text_field :description -%>
    </div>

    <div class='field'>
      <%= f.label :price -%>
      <%= f.text_field :price -%>
    </div>

    <div class='field'>
      <%= f.label :author -%>
      <%= f.text_field :author -%>
    </div>
      
    <div class='field'>
      <%= f.label :exchange -%>
      <%= f.number_field :exchange -%>
    </div>
    
    <div class='field'>
      <%= f.label :bonus -%>
      <%= f.number_field :bonus -%>
    </div>
    
    <div>   
      <%= f.label :category %><br />
      <%= collection_select(:category, :category_id, @editcategories,:id, :name)-%>
    </div>
    
    <div>
      <label>Subcategorias  </label>
      <%= f.collection_select :subcategory_id, @editsubcategories, :id, :name  %>
    </div>

        <%=f.check_box(:delete_attach) %><!--no se muestra en la vista, se usa por debajo para borrar el archivo de descarga asociado-->      
    <div id="actualfile">

      <% if f.object.attach_file_name.nil? %>
      <!--si tiene un archivo de descarga asociado-->
        <!--si no tiene un archivo de descarga asociado-->
        <a id="add_file_link" onclick="add_first_file();" >Agregar Archivo</a> <br>     
      <% else %>
        <h3>Archivo a descargar:</h3>
        <%=  @product.attach_file_name %></br>
        <a id="delete_file_link" onclick="delete_file();">Eliminar</a> 
        <a id="change_file_link"onclick="change_file();" >Cambiar</a> </br>
        <%end%>
    </div>

  <%= render '/refinery/admin/form_actions', 
              :f => f,
              :continue_editing => false,
              :delete_title => t('delete', :scope => 'refinery.products.admin.products.product'),
              :delete_confirmation => t('message', :scope => 'refinery.admin.delete', :title => @product.name) -%>
<% end -%>